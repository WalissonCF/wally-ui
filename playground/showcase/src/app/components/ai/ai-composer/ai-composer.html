<div class="w-full flex flex-col" role="region" aria-label="AI message composer">
  <!-- Selected Text Context -->
  @if (textSelected()) {
  <div class="p-0.5">
    <div id="selected-context"
      class="w-full max-h-36 overflow-auto flex items-start gap-4 justify-between border bg-neutral-100 border-neutral-300 dark:bg-[#121212] dark:border-neutral-700 rounded-t-3xl rounded-b-lg px-3 py-4"
      role="status" aria-live="polite">
      <!-- Ícone Esquerda -->
      <div class="flex items-center shrink-0">
        <svg xmlns="http://www.w3.org/2000/svg" class="size-5 text-[#0a0a0a] dark:text-white" fill="currentColor" stroke="currentColor"
          stroke-width="2" viewBox="0 0 256 256">
          <path
            d="M229.66,157.66l-48,48a8,8,0,0,1-11.32-11.32L204.69,160H128A104.11,104.11,0,0,1,24,56a8,8,0,0,1,16,0,88.1,88.1,0,0,0,88,88h76.69l-34.35-34.34a8,8,0,0,1,11.32-11.32l48,48A8,8,0,0,1,229.66,157.66Z">
          </path>
        </svg>
      </div>

      <!-- Texto Central -->
      <div class="flex-1 flex items-center">
        <p class="text-sm text-[#0a0a0a] dark:text-white line-clamp-2" id="context-label">
          "{{ textSelected() }}"
        </p>
      </div>

      <!-- Botão Direita -->
      <div class="flex items-center h-5">
        <wally-button (buttonClick)="clearTextSelected()" [variant]="'ghost'" [rounded]="true"
          [ariaLabel]="'Clear selected context'">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"
            class="size-5" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
          </svg>
        </wally-button>
      </div>
    </div>
  </div>
  }

  <div class="w-full px-4 pt-4 transition-all duration-1000 ease-in-out overflow-hidden"
    [class.opacity-0]="isStartRecoding()" [class.opacity-100]="!isStartRecoding()" [class.max-h-0]="isStartRecoding()"
    [class.max-h-96]="!isStartRecoding()">
    <wally-ai-prompt-input></wally-ai-prompt-input>
  </div>

  <!-- Transcription Badge -->
  @if (isTranscribing()) {
  <div class="w-full px-4 pb-2 transition-all duration-300 ease-in-out animate-in fade-in slide-in-from-top-2">
    <div class="inline-flex items-center gap-2 px-3 py-1.5
                bg-white/90 dark:bg-neutral-900/90
                backdrop-blur-md shadow-lg
                border border-neutral-200/50 dark:border-neutral-700/50
                rounded-full transition-all duration-300">
      <!-- Waveform animation (3 bars) -->
      <div class="flex items-center gap-0.5 h-3.5">
        <span class="w-[1.5px] bg-blue-500 rounded-full animate-pulse"
              style="height: 55%; animation-duration: 0.8s; animation-delay: 0ms;"></span>
        <span class="w-[1.5px] bg-blue-500 rounded-full animate-pulse"
              style="height: 72%; animation-duration: 0.8s; animation-delay: 150ms;"></span>
        <span class="w-[1.5px] bg-blue-500 rounded-full animate-pulse"
              style="height: 55%; animation-duration: 0.8s; animation-delay: 300ms;"></span>
      </div>
      <span class="text-xs font-medium text-neutral-700 dark:text-neutral-300">
        Listening...
      </span>
    </div>
  </div>
  }

  <div class="w-full transition-all duration-700 ease-in-out overflow-hidden" [class.opacity-0]="!isStartRecoding()"
    [class.opacity-100]="isStartRecoding()" [class.scale-95]="!isStartRecoding()" [class.scale-100]="isStartRecoding()"
    [class.max-h-0]="!isStartRecoding()" [class.max-h-32]="isStartRecoding()">
    <wally-audio-waveform
      [isStartRecording]="isStartRecoding()"
      [isStopRecording]="isStopRecoding()"
      [enableTranscription]="true"
      [transcriptionLanguage]="'pt-BR'"
      (transcriptionText)="onTranscriptionUpdate($event)"
      (transcriptionStateChange)="onTranscriptionStateChange($event)">
    </wally-audio-waveform>
  </div>

  <!-- Action Buttons -->
  <div class="w-full flex items-center justify-between p-1" role="toolbar" aria-label="Composer actions">
    <div class="w-full flex items-center gap-1">
      <div class="size-10">
        <wally-dropdown-menu>
          <wally-dropdown-menu-trigger>
            <wally-tooltip [text]="'Add files and more'" position="bottom">
              <wally-button [variant]="'ghost'" [rounded]="true" [ariaLabel]="'Add attachment or insert content'">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                  stroke="currentColor" class="size-5" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
              </wally-button>
            </wally-tooltip>
          </wally-dropdown-menu-trigger>

          <wally-dropdown-menu-content [position]="'top'">
            <!-- Grupo 1: Configurações da conta -->
            <wally-dropdown-menu-group [ariaLabel]="'Account settings'">
              <wally-dropdown-menu-item (click)="onItemClick()">
                <div class="flex items-center gap-3">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.383a14.406 14.406 0 0 1-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 1 0-7.517 0c.85.493 1.509 1.333 1.509 2.316V18" />
                  </svg>

                  <span>
                    Think
                  </span>
                </div>
              </wally-dropdown-menu-item>

              <wally-dropdown-menu-item (click)="onItemClick()">
                <div class="flex items-center gap-3">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M9 8.25H7.5a2.25 2.25 0 0 0-2.25 2.25v9a2.25 2.25 0 0 0 2.25 2.25h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25H15m0-3-3-3m0 0-3 3m3-3V15" />
                  </svg>

                  <span>
                    Upload File
                  </span>
                </div>
              </wally-dropdown-menu-item>

              <!-- Submenu -->
              <wally-dropdown-menu-sub>
                <wally-dropdown-menu-sub-trigger>
                  <div class="flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                      stroke="currentColor" class="size-6">
                      <path stroke-linecap="round" stroke-linejoin="round"
                        d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
                    </svg>

                    <span>
                      More
                    </span>
                  </div>
                </wally-dropdown-menu-sub-trigger>

                <wally-dropdown-menu-sub-content>
                  <wally-dropdown-menu-item (click)="onItemClick()">
                    <div class="flex items-center gap-3">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="size-6">
                        <path stroke-linecap="round" stroke-linejoin="round"
                          d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 0 1 7.843 4.582M12 3a8.997 8.997 0 0 0-7.843 4.582m15.686 0A11.953 11.953 0 0 1 12 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0 1 21 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0 1 12 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 0 1 3 12c0-1.605.42-3.113 1.157-4.418" />
                      </svg>

                      <span>
                        Search the web
                      </span>
                    </div>
                  </wally-dropdown-menu-item>
                  <wally-dropdown-menu-item (click)="onItemClick()">
                    <div class="flex items-center gap-3">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="size-6">
                        <path stroke-linecap="round" stroke-linejoin="round"
                          d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.62 48.62 0 0 1 12 20.904a48.62 48.62 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.636 50.636 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.717 50.717 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" />
                      </svg>

                      <span>
                        Study
                      </span>
                    </div>
                  </wally-dropdown-menu-item>
                  <!-- <wally-dropdown-menu-item (click)="onItemClick()">
                                        Privacidade
                                    </wally-dropdown-menu-item> -->
                </wally-dropdown-menu-sub-content>
              </wally-dropdown-menu-sub>
            </wally-dropdown-menu-group>

            <!-- <wally-dropdown-menu-separator></wally-dropdown-menu-separator> -->

            <!-- Item individual -->
            <!-- <wally-dropdown-menu-item (click)="onItemClick()">
                            Sair
                        </wally-dropdown-menu-item> -->
          </wally-dropdown-menu-content>

        </wally-dropdown-menu>
      </div>

      <!-- Tools Dinâmicas -->
      @for (tool of enabledTools(); track tool.id) {
      @if (tool.enabled) {
      <div>
        <wally-button variant="ghost" [rounded]="true" (buttonClick)="tool.onClick()">
          <div class="group flex items-center gap-2">
            <!-- Ícone de Remover (hover) -->
            <div class="max-w-0 group-hover:max-w-6 overflow-hidden transition-all duration-300 ease-in-out">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor"
                class="opacity-0 group-hover:opacity-100 transition-opacity duration-300 size-6 rounded-full p-0.5 bg-neutral-300/40 dark:bg-white/10"
                aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
              </svg>
            </div>

            <!-- Ícone da Tool -->
            <div [innerHTML]="getToolIcon(tool.icon)"></div>

            <!-- Nome da Tool -->
            <span class="text-base font-semibold">{{ tool.name }}</span>
          </div>
        </wally-button>
      </div>
      }
      }
    </div>

    <div class="w-full size-10 flex gap-2 justify-end">
      <div>
        <wally-tooltip [text]="isStartRecoding() ? 'Stop recording' : 'Use voice input'" position="bottom">
          <wally-button (buttonClick)="toggleInputVoice()" [variant]="'ghost'" [rounded]="true"
            [ariaLabel]="'Send message'">
            @if (isStartRecoding()) {
            <svg xmlns="http://www.w3.org/2000/svg" class="size-6" fill="currentColor" stroke="currentColor"
              stroke-width="3" viewBox="0 0 256 256">
              <path
                d="M213.92,218.62l-160-176A8,8,0,0,0,42.08,53.38L80,95.09V128a48,48,0,0,0,69.11,43.12l11.1,12.2A63.41,63.41,0,0,1,128,192a64.07,64.07,0,0,1-64-64,8,8,0,0,0-16,0,80.11,80.11,0,0,0,72,79.6V240a8,8,0,0,0,16,0V207.59a78.83,78.83,0,0,0,35.16-12.22l30.92,34a8,8,0,1,0,11.84-10.76ZM128,160a32,32,0,0,1-32-32V112.69l41.66,45.82A32,32,0,0,1,128,160Zm57.52-3.91A63.32,63.32,0,0,0,192,128a8,8,0,0,1,16,0,79.16,79.16,0,0,1-8.11,35.12,8,8,0,0,1-7.19,4.49,7.88,7.88,0,0,1-3.51-.82A8,8,0,0,1,185.52,156.09ZM84,44.87A48,48,0,0,1,176,64v64a49.19,49.19,0,0,1-.26,5,8,8,0,0,1-8,7.17,8.13,8.13,0,0,1-.84,0,8,8,0,0,1-7.12-8.79c.11-1.1.17-2.24.17-3.36V64A32,32,0,0,0,98.64,51.25,8,8,0,1,1,84,44.87Z">
              </path>
            </svg>
            } @else {
            <svg xmlns="http://www.w3.org/2000/svg" class="size-6" fill="currentColor" stroke-width="3"
              stroke="currentColor" viewBox="0 0 256 256">
              <path
                d="M128,176a48.05,48.05,0,0,0,48-48V64a48,48,0,0,0-96,0v64A48.05,48.05,0,0,0,128,176ZM96,64a32,32,0,0,1,64,0v64a32,32,0,0,1-64,0Zm40,143.6V240a8,8,0,0,1-16,0V207.6A80.11,80.11,0,0,1,48,128a8,8,0,0,1,16,0,64,64,0,0,0,128,0,8,8,0,0,1,16,0A80.11,80.11,0,0,1,136,207.6Z">
              </path>
            </svg>
            }

          </wally-button>
        </wally-tooltip>
      </div>

      <div>
        <wally-button (buttonClick)="aiChatService.sendMessage()" [disabled]="!(isCurrentUserMessageValid$ | async)"
          [variant]="'primary'" [rounded]="true" [ariaLabel]="'Send message'">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"
            class="size-5" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5 12 3m0 0 7.5 7.5M12 3v18" />
          </svg>
        </wally-button>
      </div>
    </div>
  </div>
</div>
